<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Sterowania - Pok√≥j Zagadek</title>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}
body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: #1a1a1a;
min-height: 100vh;
color: #e0e0e0;
}
.container {
max-width: 1200px;
margin: 0 auto;
padding: 20px;
}
.header {
text-align: center;
color: #e0e0e0;
margin-bottom: 30px;
}
.header h1 {
font-size: 2.5em;
text-shadow: none;
margin-bottom: 10px;
color: #ab0911;
}
.main-panel {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 20px;
margin-bottom: 20px;
}
.card {
background: #2a2a2a;
border: 1px solid #404040;
border-radius: 8px;
padding: 25px;
box-shadow: none;
}
.card h2 {
margin-bottom: 20px;
color: #e0e0e0;
border-bottom: 1px solid #404040;
padding-bottom: 10px;
font-size: 1.2em;
}
.form-group {
margin-bottom: 15px;
}
.form-group label {
display: block;
margin-bottom: 5px;
font-weight: 500;
color: #b0b0b0;
}
.form-group input, .form-group textarea, .form-group select {
width: 100%;
padding: 12px;
border: 1px solid #404040;
border-radius: 4px;
font-size: 16px;
background: #333;
color: #e0e0e0;
transition: border-color 0.3s;
}
.form-group input:focus, .form-group textarea:focus, .form-group select:focus {
outline: none;
border-color: #ab0911;
box-shadow: none;
}
.checkbox-group {
display: flex;
align-items: center;
gap: 10px;
margin: 15px 0;
}
.checkbox-group input[type="checkbox"] {
width: auto;
transform: scale(1.2);
}
.btn {
padding: 10px 20px;
border: none;
border-radius: 4px;
font-size: 14px;
font-weight: 500;
cursor: pointer;
transition: all 0.2s;
margin: 5px;
}
.btn-primary {
background: #ab0911;
color: white;
}
.btn-success {
background: #4a5a4a;
color: white;
}
.btn-warning {
background: #6b5a2d;
color: white;
}
.btn-danger {
background: #5a3030;
color: white;
}
.btn:hover {
opacity: 0.9;
transform: none;
box-shadow: none;
}
.btn:disabled {
opacity: 0.6;
cursor: not-allowed;
transform: none;
}
.game-status {
text-align: center;
padding: 15px;
border-radius: 4px;
margin: 15px 0;
font-weight: 500;
font-size: 16px;
border: 1px solid #404040;
}
.status-waiting {
background: #333;
color: #b0b0b0;
}
.status-active {
background: #2a3f2a;
color: #90c090;
border-color: #4a5a4a;
}
.status-paused {
background: #3f3a2a;
color: #c0a090;
border-color: #6b5a2d;
}
.timer {
font-size: 2.8em;
font-weight: bold;
text-align: center;
margin: 15px 0;
color: #e0e0e0;
}
.hint-request {
background: #4a2a2a;
color: #e0b0b0;
padding: 15px;
border: 1px solid #ab0911;
border-radius: 4px;
margin: 10px 0;
text-align: center;
font-weight: 500;
font-size: 16px;
animation: pulse 1.5s infinite;
}
@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.7; }
}
.hint-panel {
grid-column: 1 / -1;
}
.audio-controls {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 15px;
margin: 20px 0;
padding: 20px;
border: 2px solid #404040;
border-radius: 8px;
background: #2a2a2a;
}
.audio-control-item {
text-align: center;
}
.audio-control-item label {
display: block;
margin-bottom: 10px;
font-weight: bold;
color: #e0e0e0;
}
.audio-btn {
width: 100%;
padding: 15px;
font-size: 16px;
border-radius: 8px;
border: none;
cursor: pointer;
transition: all 0.3s;
margin: 5px 0;
}
.audio-btn-primary {
background: #ab0911;
color: white;
}
.audio-btn-success {
background: #4a5a4a;
color: white;
}
.audio-btn-danger {
background: #5a3030;
color: white;
}
.audio-btn:hover {
opacity: 0.8;
transform: translateY(-2px);
}
.logs-panel {
grid-column: 1 / -1;
max-height: 300px;
overflow-y: auto;
}
.log-entry {
padding: 10px;
margin: 5px 0;
border-radius: 4px;
border-left: 3px solid #404040;
background: #333;
font-family: monospace;
font-size: 13px;
color: #b0b0b0;
}
.log-game {
border-left-color: #4a5a4a;
}
.log-hint {
border-left-color: #6b5a2d;
}
.log-error {
border-left-color: #ab0911;
}
.log-esp32 {
border-left-color: #0066cc;
}
.connection-status {
position: fixed;
top: 20px;
right: 20px;
padding: 10px 15px;
border-radius: 20px;
color: white;
font-weight: bold;
z-index: 1000;
}
.connected {
background: #4a5a4a;
}
.connecting {
background: #6b5a2d;
}
.disconnected {
background: #ab0911;
}
.device-status {
padding: 10px;
border-radius: 4px;
margin: 5px 0;
text-align: center;
font-weight: bold;
}
.device-online {
background: #2a3f2a;
color: #90c090;
}
.device-offline {
background: #4a2a2a;
color: #e0b0b0;
}
.game-history-item {
background: #333;
border: 1px solid #404040;
border-radius: 4px;
padding: 15px;
margin-bottom: 10px;
transition: background-color 0.2s;
}
.game-history-item:hover {
background: #3a3a3a;
}
.game-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 10px;
}
.game-title {
font-size: 1.1em;
font-weight: bold;
color: #e0e0e0;
}
.game-date {
color: #b0b0b0;
font-size: 0.9em;
}
.game-details {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
gap: 10px;
margin-bottom: 10px;
}
.game-detail {
color: #b0b0b0;
font-size: 0.9em;
}
.game-status-badge {
padding: 4px 8px;
border-radius: 12px;
font-size: 0.8em;
font-weight: bold;
}
.status-completed {
background: #4a5a4a;
color: #90c090;
}
.status-failed {
background: #5a3030;
color: #c09090;
}
.status-test {
background: #3f3a2a;
color: #c0a090;
}
.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 15px;
}
.stat-item {
text-align: center;
padding: 10px;
background: #2a2a2a;
border-radius: 4px;
}
.stat-value {
font-size: 1.5em;
font-weight: bold;
color: #ab0911;
}
.stat-label {
color: #b0b0b0;
font-size: 0.9em;
}
.notification {
position: fixed;
top: 70px;
right: 20px;
padding: 15px 20px;
border-radius: 4px;
color: white;
font-weight: bold;
z-index: 1000;
transform: translateX(400px);
transition: transform 0.3s ease;
}
.notification.show {
transform: translateX(0);
}
.notification-success {
background: #4a5a4a;
}
.notification-error {
background: #ab0911;
}
.notification-warning {
background: #6b5a2d;
}
.wifi-info {
background: #2a2a3a;
border: 1px solid #404040;
border-radius: 4px;
padding: 15px;
margin-bottom: 15px;
font-family: monospace;
font-size: 14px;
}
.pricing-calculator {
background: #2a2a2a;
border: 1px solid #404040;
border-radius: 8px;
padding: 25px;
margin-bottom: 20px;
}
.pricing-row {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 20px;
margin-bottom: 15px;
align-items: center;
}
.radio-group {
display: flex;
gap: 20px;
align-items: center;
}
.radio-group input[type="radio"] {
width: auto;
transform: scale(1.2);
}
.pricing-result {
background: #1a3a1a;
border: 2px solid #4a5a4a;
border-radius: 8px;
padding: 20px;
text-align: center;
margin: 20px 0;
}
.pricing-total {
font-size: 2em;
font-weight: bold;
color: #90c090;
}
.pricing-breakdown {
color: #b0b0b0;
margin-top: 10px;
font-size: 0.9em;
}
.stage-indicator {
display: flex;
align-items: center;
gap: 10px;
padding: 8px;
background: #444;
border-radius: 4px;
}
.stage-circle {
width: 24px;
height: 24px;
border-radius: 50%;
background: #666;
color: white;
display: flex;
align-items: center;
justify-content: center;
font-weight: bold;
font-size: 12px;
}
.stage-text {
flex: 1;
color: #e0e0e0;
font-weight: 500;
}
.stage-status {
font-size: 16px;
}
.stage-waiting .stage-circle {
background: #666;
}
.stage-active .stage-circle {
background: #ab0911;
animation: pulse-red 1.5s infinite;
}
.stage-completed .stage-circle {
background: #4a5a4a;
}
.stage-waiting .stage-status::before {
content: "‚è≥";
}
.stage-active .stage-status::before {
content: "üîÑ";
}
.stage-completed .stage-status::before {
content: "‚úÖ";
}
@keyframes pulse-red {
0%, 100% { opacity: 1; }
50% { opacity: 0.6; }
}
.digit-stat {
background: #555;
border-radius: 4px;
padding: 8px 4px;
text-align: center;
}
.digit-stat-number {
font-weight: bold;
color: #e0e0e0;
font-size: 14px;
}
.digit-stat-bar {
height: 20px;
background: #666;
border-radius: 2px;
margin: 5px 0;
position: relative;
overflow: hidden;
}
.digit-stat-fill {
height: 100%;
background: linear-gradient(90deg, #ab0911, #d42c40);
border-radius: 2px;
transition: width 0.3s ease;
}
.digit-stat-count {
font-size: 10px;
color: #b0b0b0;
}
.code-entry {
padding: 5px 8px;
margin: 2px 0;
background: #444;
border-radius: 3px;
border-left: 3px solid #ab0911;
}
.code-entry-code {
font-weight: bold;
color: #e0e0e0;
}
.code-entry-time {
color: #b0b0b0;
font-size: 10px;
}
.code-entry-correct {
border-left-color: #4a5a4a;
}
.code-entry-correct .code-entry-code {
color: #90c090;
}
</style>
</head>
<body>
<div class="connection-status" id="connectionStatus">
üü° ≈Åadowanie...
</div>
<div class="container">
<div class="header">
<h1>Panel Sterowania Pokoju Zagadek</h1>
<p>System zarzƒÖdzania grƒÖ escape room</p>
</div>
<!-- Nawigacja -->
<div style="text-align: center; margin-bottom: 20px;">
<button class="btn btn-primary" onclick="showPanel('game')" id="gameTab">Gra</button>
<button class="btn btn-success" onclick="showPanel('puzzles')" id="puzzlesTab">Zagadki</button>
<button class="btn btn-success" onclick="showPanel('history')" id="historyTab">Historia</button>
<button class="btn btn-warning" onclick="showPanel('pricing')" id="pricingTab">Cennik</button>
<button class="btn btn-warning" onclick="showPanel('config')" id="configTab">Konfiguracja</button>
</div>
<!-- Panel Gry -->
<div id="gamePanel">
<div class="main-panel">
<!-- Rejestracja grupy -->
<div class="card">
<h2>Rejestracja Grupy</h2>
<div class="form-group">
<label for="groupName">Nazwa grupy:</label>
<input type="text" id="groupName" placeholder="np. Dru≈ºyna Alpha">
</div>
<div class="form-group">
<label for="playerCount">Liczba graczy:</label>
<select id="playerCount">
<option value="2">2 graczy</option>
<option value="3">3 graczy</option>
<option value="4">4 graczy</option>
<option value="5">5 graczy</option>
<option value="6">6 graczy</option>
</select>
</div>
<div class="checkbox-group">
<input type="checkbox" id="testGame">
<label for="testGame">Gra testowa</label>
</div>
<button class="btn btn-primary" onclick="startGame()">Rozpocznij Grƒô</button>
</div>
<!-- Status gry -->
<div class="card">
<h2>Status Gry</h2>
<div id="gameStatus" class="game-status status-waiting">
Oczekiwanie na rozpoczƒôcie gry
</div>
<div id="timer" class="timer">00:00</div>
<div id="gameInfo" style="text-align: center; color: #666;">
Brak aktywnej sesji
</div>
<div style="text-align: center; margin-top: 15px;">
<button class="btn btn-warning" onclick="pauseGame()" disabled id="pauseBtn">Pauza</button>
<button class="btn btn-danger" onclick="stopGame()" disabled id="stopBtn">Stop</button>
<button class="btn btn-success" onclick="completeGame()" disabled id="completeBtn">Uko≈Ñczono</button>
</div>
</div>
</div>
<!-- ≈ªƒÖdanie podpowiedzi -->
<div id="hintRequest" class="hint-request" style="display: none;">
üîî GRACZE PROSZƒÑ O PODPOWIED≈π (GO≈ÅƒÑB)
<button class="btn btn-danger" onclick="hideHintRequest()" style="margin-left: 15px; padding: 5px 10px;">Ukryj</button>
</div>
<!-- Panel podpowiedzi -->
<div class="card hint-panel">
<h2>üéµ Panel Podpowiedzi Audio - Go≈ÇƒÖb</h2>
<!-- Suwak g≈Ço≈õno≈õci -->
<div style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
<label for="volumeSlider" style="display: block; margin-bottom: 10px; font-weight: bold; color: #e0e0e0;">üîä G≈Ço≈õno≈õƒá Audio (0-30):</label>
<div style="display: flex; align-items: center; gap: 15px;">
<span style="color: #b0b0b0;">0</span>
<input type="range" id="volumeSlider" min="0" max="30" value="20" style="flex: 1; height: 10px; background: #555; outline: none; border-radius: 5px;" oninput="setVolume(this.value)">
<span style="color: #b0b0b0;">30</span>
<span id="volumeValue" style="color: #e0e0e0; font-weight: bold; min-width: 40px;">20</span>
</div>
</div>
<div class="audio-controls">
<div class="audio-control-item">
<label>üïäÔ∏è TESTY - Tylko 2 pliki</label>
<button class="audio-btn audio-btn-primary" onclick="playAudio('golab')">Test 1 (001.mp3)</button>
<button class="audio-btn audio-btn-success" onclick="playAudio('hint1')">Test 2 (002.mp3)</button>
<button class="audio-btn audio-btn-success" onclick="playAudio('hint2')">Test 2 ponownie</button>
<button class="audio-btn audio-btn-danger" onclick="stopAudio()">‚èπÔ∏è STOP</button>
</div>
</div>
</div>
<!-- Logi -->
<div class="card logs-panel">
<h2>Logi Systemu</h2>
<div style="text-align: right; margin-bottom: 10px;">
<button class="btn btn-warning" onclick="clearLogs()">Wyczy≈õƒá logi</button>
</div>
<div id="logs">
<div class="log-entry">
<strong>[System]</strong> Panel uruchomiony - oczekiwanie na po≈ÇƒÖczenie
</div>
</div>
</div>
</div>
<!-- Panel Zagadki -->
<div id="puzzlesPanel" style="display: none;">
<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
<!-- Walizka LOTTO -->
<div class="card">
<h2>üß≥ Walizka LOTTO</h2>
<div style="margin-bottom: 20px;">
<div style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
<h3 style="margin-bottom: 10px; color: #e0e0e0;">üìç Status Etap√≥w</h3>
<div style="display: flex; flex-direction: column; gap: 10px;">
<div id="stage1Status" class="stage-indicator">
<span class="stage-circle">1</span>
<span class="stage-text">Tag RFID 1</span>
<span class="stage-status">‚è≥</span>
</div>
<div id="stage2Status" class="stage-indicator">
<span class="stage-circle">2</span>
<span class="stage-text">Klawiatura</span>
<span class="stage-status">‚è≥</span>
</div>
<div id="stage3Status" class="stage-indicator">
<span class="stage-circle">3</span>
<span class="stage-text">Tag RFID 2</span>
<span class="stage-status">‚è≥</span>
</div>
</div>
</div>
<div style="text-align: center; margin-bottom: 15px;">
<button class="btn btn-primary" onclick="openLock()" id="openLockBtn">üîì Otw√≥rz Zamek</button>
<button class="btn btn-warning" onclick="resetPuzzle('walizka')" id="resetPuzzleBtn">üîÑ Reset Zagadki</button>
</div>
</div>
<div style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
<h3 style="margin-bottom: 10px; color: #e0e0e0;">üìù Historia Kod√≥w</h3>
<div id="codesHistory" style="max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 12px;">
<div style="color: #666; text-align: center; padding: 10px;">Brak pr√≥b</div>
</div>
</div>
<div style="background: #333; padding: 15px; border-radius: 8px;">
<h3 style="margin-bottom: 10px; color: #e0e0e0;">üìä Statystyki Cyfr</h3>
<div id="digitStats" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; font-size: 11px;">
<!-- Cyfry 0-9 bƒôdƒÖ tu generowane przez JS -->
</div>
</div>
</div>
<!-- Zagadka #2 - Placeholder -->
<div class="card">
<h2>üîí Zagadka #2</h2>
<div style="text-align: center; color: #666; padding: 40px 20px;">
<div style="font-size: 48px; margin-bottom: 20px;">üöß</div>
<h3>W Przygotowaniu</h3>
<p>Kolejna zagadka bƒôdzie<br>dostƒôpna wkr√≥tce</p>
</div>
</div>
<!-- Zagadka #3 - Placeholder -->
<div class="card">
<h2>üé≤ Zagadka #3</h2>
<div style="text-align: center; color: #666; padding: 40px 20px;">
<div style="font-size: 48px; margin-bottom: 20px;">üöß</div>
<h3>W Przygotowaniu</h3>
<p>Kolejna zagadka bƒôdzie<br>dostƒôpna wkr√≥tce</p>
</div>
</div>
</div>
</div>
<!-- Panel Cennik -->
<div id="pricingPanel" style="display: none;">
<div class="card pricing-calculator">
<h2>üí∞ Kalkulator Cennik</h2>
<div class="pricing-row">
<div class="form-group">
<label for="groupSize">üìä Liczebno≈õƒá grupy:</label>
<select id="groupSize" onchange="updateSelectedCountVisibility(); calculatePrice();">
<option value="2">2 osoby</option>
<option value="3">3 osoby</option>
<option value="4" selected>4 osoby</option>
<option value="5">5 os√≥b</option>
<option value="6">6 os√≥b</option>
</select>
</div>
<div class="form-group">
<label for="basePrice">üíµ Cena za grupƒô (z≈Ç):</label>
<input type="number" id="basePrice" value="100" min="0" onchange="calculatePrice()">
</div>
</div>
<div class="pricing-row">
<div class="form-group">
<label for="discountType">üé´ Typ zni≈ºki:</label>
<select id="discountType" onchange="calculatePrice()">
<option value="none">Brak zni≈ºki</option>
<option value="znajomi">Znajomi Starzika</option>
<option value="tme">TME Tesla</option>
<option value="starziki">Starziki</option>
</select>
</div>
<div class="form-group">
<label>üìã Spos√≥b naliczania zni≈ºki:</label>
<div class="radio-group">
<input type="radio" id="discountAll" name="discountMode" value="all" checked onchange="updateSelectedCountVisibility(); calculatePrice();">
<label for="discountAll">üü¢ Dla ca≈Çej grupy</label>
<input type="radio" id="discountSelected" name="discountMode" value="selected" onchange="updateSelectedCountVisibility(); calculatePrice();">
<label for="discountSelected">üü° Dla wybranych os√≥b</label>
</div>
</div>
</div>
<div class="form-group">
<label>üí∏ Jednostka zni≈ºki:</label>
<div class="radio-group">
<input type="radio" id="discountUnitZl" name="discountUnit" value="amount" onchange="calculatePrice();">
<label for="discountUnitZl">üí∞ Z≈Çot√≥wki (z≈Ç)</label>
<input type="radio" id="discountUnitPercent" name="discountUnit" value="percent" checked onchange="calculatePrice();">
<label for="discountUnitPercent">üìä Procent (%)</label>
</div>
</div>
<div class="form-group">
<label for="discountValue">üí∏ Warto≈õƒá zni≈ºki:</label>
<input type="number" id="discountValue" value="20" min="0" onchange="calculatePrice()" placeholder="Wpisz warto≈õƒá zni≈ºki" style="font-size: 20px; padding: 18px; font-weight: bold;">
</div>
<div class="form-group" id="selectedCountGroup" style="display: none;">
<label for="selectedCount">üë• Ile os√≥b ze zni≈ºkƒÖ:</label>
<input type="number" id="selectedCount" value="1" min="1" max="6" onchange="calculatePrice()">
</div>
<div class="pricing-result">
<div class="pricing-total" id="totalPrice">100 z≈Ç</div>
<div class="pricing-breakdown" id="priceBreakdown">Grupa 4 os√≥b - cena pe≈Çna</div>
</div>
<div style="text-align: center; margin-top: 20px;">
<button class="btn btn-primary" onclick="applyPricingToGame()">üí∞ Zastosuj do aktualnej gry</button>
<button class="btn btn-success" onclick="savePricingPreset()">üíæ Zapisz preset</button>
<button class="btn btn-warning" onclick="resetPricing()">üîÑ Reset</button>
</div>
</div>
<div class="card">
<h2>üìã Zapisane Presety Cenowe</h2>
<div id="pricingPresets">
<p style="text-align: center; color: #666;">Brak zapisanych preset√≥w</p>
</div>
</div>
</div>
<!-- Panel Historii -->
<div id="historyPanel" style="display: none;">
<div class="card">
<h2>Historia Gier</h2>
<div style="margin-bottom: 20px;">
<div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
<input type="text" id="searchFilter" placeholder="Szukaj po nazwie grupy..." style="flex: 1; min-width: 200px;">
<select id="difficultyFilter">
<option value="">Wszystkie gry</option>
</select>
<select id="statusFilter">
<option value="">Wszystkie statusy</option>
<option value="completed">Uko≈Ñczone</option>
<option value="failed">Nieuko≈Ñczone</option>
<option value="test">Testowe</option>
</select>
<button class="btn btn-primary" onclick="applyFilters()">üîç Filtruj</button>
<button class="btn btn-success" onclick="exportToCSV()">üìä Eksport CSV</button>
<button class="btn btn-warning" onclick="loadHistoryFromESP()">üì• Pobierz z ESP32</button>
<button class="btn btn-danger" onclick="clearHistory()">üóëÔ∏è Wyczy≈õƒá historiƒô</button>
</div>
</div>
<div id="gameHistory">
<!-- Historia gier bƒôdzie tutaj -->
</div>
<div id="historyStats" style="margin-top: 20px; padding: 15px; background: #333; border-radius: 4px;">
<h3>Statystyki</h3>
<div id="statsContent">
<p>Brak danych</p>
</div>
</div>
</div>
</div>
<!-- Panel Konfiguracji -->
<div id="configPanel" style="display: none;">
<div class="card">
<h2>Status UrzƒÖdze≈Ñ</h2>
<div id="devicesStatus">
<div class="device-status device-offline" id="masterStatus">üéõÔ∏è Master: OFFLINE</div>
<div class="device-status device-offline" id="slaveStatus">üïäÔ∏è Go≈ÇƒÖb: OFFLINE</div>
<div class="device-status device-offline" id="slave3Status">üß≥ Walizka: OFFLINE</div>
</div>
</div>
<div class="card">
<h2>Informacje o Sieci WiFi</h2>
<div class="wifi-info" id="wifiInfo">
<div>Status: <span id="wifiStatus">Sprawdzanie...</span></div>
<div>IP ESP32: <span id="espIP">-</span></div>
<div>Nazwa sieci: <span id="wifiSSID">-</span></div>
<div>Si≈Ça sygna≈Çu: <span id="wifiRSSI">-</span></div>
</div>
</div>
<div class="card">
<h2>Konfiguracja Systemu</h2>
<div class="form-group">
<label for="gameTime">Czas gry (minuty):</label>
<input type="number" id="gameTime" value="60" min="1" max="180" placeholder="60" style="display: none;">
</div>
<div class="form-group">
<label for="autoHintDelay">Automatyczne podpowiedzi po (minutach):</label>
<input type="number" id="autoHintDelay" value="15" min="5" max="60" placeholder="15" style="display: none;">
</div>
<!-- Automatyczne powiadomienia czasowe -->
<div style="border: 1px solid #404040; border-radius: 4px; padding: 15px; margin-top: 20px;">
<h3 style="margin-bottom: 15px; color: #e0e0e0;">‚è∞ Automatyczne Powiadomienia Czasowe</h3>
<div class="checkbox-group">
<input type="checkbox" id="enableTimeNotifications" checked>
<label for="enableTimeNotifications">W≈ÇƒÖcz automatyczne powiadomienia</label>
</div>
<div class="form-group">
<label for="timeInterval">Interwa≈Ç powiadomie≈Ñ (minuty):</label>
<select id="timeInterval">
<option value="10">Co 10 minut</option>
<option value="15" selected>Co 15 minut</option>
<option value="20">Co 20 minut</option>
<option value="30">Co 30 minut</option>
</select>
</div>
<div class="form-group">
<label for="timeAudioFile">Plik audio powiadomie≈Ñ:</label>
<select id="timeAudioFile">
<option value="time_warning">time_warning (domy≈õlny)</option>
<option value="time_15min">time_15min (15 minut)</option>
<option value="time_30min">time_30min (30 minut)</option>
<option value="golab">golab (alternatywny)</option>
</select>
</div>
<div style="background: #333; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 12px; color: #b0b0b0;">
<strong>‚ÑπÔ∏è Informacja:</strong><br>
P√≥ki co u≈ºywane sƒÖ istniejƒÖce pliki (001.mp3, 002.mp3).<br>
Po dodaniu nowych plik√≥w MP3 na kartƒô SD automatycznie prze≈ÇƒÖczy siƒô na w≈Ça≈õciwe d≈∫wiƒôki.
</div>
<div id="timeNotificationStatus" style="color: #b0b0b0; font-size: 14px; margin-top: 10px;">
Status: Wy≈ÇƒÖczone (brak aktywnej gry)
</div>
</div>
<div style="text-align: center; margin: 20px 0;">
<button class="btn btn-primary" onclick="saveConfig()">üíæ Zapisz Konfiguracjƒô</button>
<button class="btn btn-warning" onclick="testConnection()">üîó Testuj Po≈ÇƒÖczenie</button>
<button class="btn btn-danger" onclick="resetConfig()">üîÑ Reset do Domy≈õlnych</button>
</div>
<div style="border: 1px solid #404040; border-radius: 4px; padding: 15px; margin-top: 20px;">
<h3>Komendy Systemowe</h3>
<div style="text-align: center; margin: 15px 0;">
<button class="btn btn-success" onclick="diagnostics()">üîß Diagnostyka</button>
<button class="btn btn-primary" onclick="checkAudioFiles()">üìÅ Sprawd≈∫ Pliki Audio</button>
</div>
<div style="border-top: 1px solid #404040; padding-top: 15px; margin-top: 15px;">
<h4 style="margin-bottom: 15px; color: #e0e0e0;">üîÑ Restart UrzƒÖdze≈Ñ</h4>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
<button class="btn btn-warning" onclick="restartMaster()">üîÑ Restart Master</button>
<button class="btn btn-danger" onclick="restartSlave()">üîÑ Restart Go≈ÇƒÖb</button>
<button class="btn btn-primary" onclick="restartSlave3()">üîÑ Restart Walizka</button>
<button class="btn btn-success" onclick="restartAll()">üîÑ Restart All</button>
</div>
<div id="restartCountdown" style="display: none; text-align: center; margin-top: 15px; padding: 10px; background: #4a2a2a; border-radius: 4px; color: #e0b0b0; font-weight: bold;"></div>
</div>
</div>
</div>
</div>
<script>
// Konfiguracja systemu
let config = {
gameTime: 60,
autoHintDelay: 15,
enableTimeNotifications: true,
timeInterval: 15,
timeAudioFile: 'time_warning'
};
// Zmienne globalne
let gameActive = false;
let gamePaused = false;
let startTime = null;
let timerInterval = null;
let currentSession = null;
let gameHistory = [];
let currentPanel = 'game';
let slaveConnected = false;
let timeNotificationTimer = null;
let lastTimeNotification = 0;
let autoHintTimer = null;
let pricingPresets = [];

// Zmienne dla zagadek
let puzzleStates = {
    walizka: {
        stage: 'WAITING_TAG1', // KEYPAD_ACTIVE, WAITING_TAG2, COMPLETED
        codesHistory: [],
        digitStats: {0:0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0},
        relayState: false,
        lastUpdate: 0
    }
};
let slave3Connected = false;

// FUNKCJE CENNIKA
function calculatePrice() {
    try {
        const groupSize = parseInt(document.getElementById('groupSize').value) || 4;
        const basePrice = parseFloat(document.getElementById('basePrice').value) || 0;
        const discountType = document.getElementById('discountType').value;
        const discountModeElement = document.querySelector('input[name="discountMode"]:checked');
        const discountMode = discountModeElement ? discountModeElement.value : 'all';
        const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
        const discountUnitElement = document.querySelector('input[name="discountUnit"]:checked');
        const discountUnit = discountUnitElement ? discountUnitElement.value : 'percent';
        const selectedCount = parseInt(document.getElementById('selectedCount').value) || 1;

        let finalPrice = basePrice;
        let breakdown = `Grupa ${groupSize} os√≥b`;

        if (discountType !== 'none' && discountValue > 0) {
            let discountAmount = 0;

            if (discountMode === 'all') {
                // Zni≈ºka dla ca≈Çej grupy
                if (discountUnit === 'percent') {
                    discountAmount = basePrice * (discountValue / 100);
                    breakdown += ` - ${discountValue}% dla ca≈Çej grupy`;
                } else {
                    discountAmount = discountValue;
                    breakdown += ` - ${discountValue}z≈Ç dla ca≈Çej grupy`;
                }
                finalPrice = basePrice - discountAmount;
            } else {
                // Zni≈ºka dla wybranych os√≥b
                if (discountUnit === 'percent') {
                    discountAmount = basePrice * (discountValue / 100) * (selectedCount / groupSize);
                    breakdown += ` - ${discountValue}% dla ${selectedCount} os√≥b`;
                } else {
                    discountAmount = discountValue;
                    breakdown += ` - ${discountValue}z≈Ç dla ${selectedCount} os√≥b`;
                }
                finalPrice = basePrice - discountAmount;
            }

            const discountName = getDiscountName(discountType);
            breakdown += ` (${discountName})`;
        } else {
            breakdown += ' - cena pe≈Çna';
        }

        // Nie pozw√≥l na cenƒô ujemnƒÖ
        finalPrice = Math.max(0, finalPrice);

        const totalElement = document.getElementById('totalPrice');
        const breakdownElement = document.getElementById('priceBreakdown');
        
        if (totalElement) {
            totalElement.textContent = finalPrice.toFixed(0) + ' z≈Ç';
        }
        if (breakdownElement) {
            breakdownElement.textContent = breakdown;
        }
        
    } catch (error) {
        console.error('Error in calculatePrice:', error);
    }
}

function updateSelectedCountVisibility() {
    try {
        const discountModeElement = document.querySelector('input[name="discountMode"]:checked');
        const selectedCountGroup = document.getElementById('selectedCountGroup');
        
        if (!discountModeElement || !selectedCountGroup) {
            return;
        }
        
        const discountMode = discountModeElement.value;
        
        if (discountMode === 'selected') {
            selectedCountGroup.style.display = 'block';
            // Ustaw maksymalnƒÖ liczbƒô os√≥b ze zni≈ºkƒÖ r√≥wnƒÖ wielko≈õci grupy
            const groupSize = parseInt(document.getElementById('groupSize').value) || 4;
            const selectedCountInput = document.getElementById('selectedCount');
            if (selectedCountInput) {
                selectedCountInput.max = groupSize;
                if (parseInt(selectedCountInput.value) > groupSize) {
                    selectedCountInput.value = groupSize;
                }
            }
        } else {
            selectedCountGroup.style.display = 'none';
        }
    } catch (error) {
        console.error('Error in updateSelectedCountVisibility:', error);
    }
}

function getDiscountName(type) {
    switch(type) {
        case 'znajomi': return 'Znajomi Starzika';
        case 'tme': return 'TME Tesla';  
        case 'starziki': return 'Starziki';
        default: return 'Zni≈ºka';
    }
}

function resetPricing() {
    document.getElementById('groupSize').value = '4';
    document.getElementById('basePrice').value = '100';
    document.getElementById('discountType').value = 'none';
    document.getElementById('discountValue').value = '20';
    document.getElementById('discountUnitPercent').checked = true;
    document.getElementById('discountAll').checked = true;
    document.getElementById('selectedCount').value = '1';
    updateSelectedCountVisibility();
    calculatePrice();
}

function applyPricingToGame() {
    const finalPrice = document.getElementById('totalPrice').textContent;
    const breakdown = document.getElementById('priceBreakdown').textContent;

    if (currentSession) {
        currentSession.price = finalPrice;
        currentSession.priceBreakdown = breakdown;
        showNotification(`Cennik zastosowany: ${finalPrice}`, 'success');
        addLog('game', `Cennik: ${breakdown} = ${finalPrice}`);
    } else {
        showNotification('Brak aktywnej gry - rozpocznij grƒô aby zastosowaƒá cennik', 'warning');
    }
}

function savePricingPreset() {
    const groupSize = document.getElementById('groupSize').value;
    const basePrice = document.getElementById('basePrice').value;
    const discountType = document.getElementById('discountType').value;
    const discountValue = document.getElementById('discountValue').value;
    const discountUnitElement = document.querySelector('input[name="discountUnit"]:checked');
    const discountUnit = discountUnitElement ? discountUnitElement.value : 'percent';

    const presetName = prompt('Nazwa presetu:', `${getDiscountName(discountType)} ${groupSize} os√≥b`);
    if (!presetName) return;

    const preset = {
        id: Date.now(),
        name: presetName,
        groupSize: groupSize,
        basePrice: basePrice,
        discountType: discountType,
        discountValue: discountValue,
        discountUnit: discountUnit
    };

    pricingPresets.push(preset);
    if (window.localStorage) {
        window.localStorage.setItem('pricingPresets', JSON.stringify(pricingPresets));
    }
    updatePresetsDisplay();
    showNotification('Preset zapisany!', 'success');
}

function updatePresetsDisplay() {
    const container = document.getElementById('pricingPresets');

    if (pricingPresets.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">Brak zapisanych preset√≥w</p>';
        return;
    }

    container.innerHTML = '';
    pricingPresets.forEach(preset => {
        const div = document.createElement('div');
        div.className = 'game-history-item';
        div.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>${preset.name}</strong><br>
                    <small>Grupa ${preset.groupSize} os√≥b, ${preset.basePrice}z≈Ç, ${getDiscountName(preset.discountType)} ${preset.discountValue}${preset.discountUnit === 'percent' ? '%' : 'z≈Ç'}</small>
                </div>
                <div>
                    <button class="btn btn-success" onclick="loadPreset(${preset.id})" style="font-size: 12px; padding: 5px 10px;">Wczytaj</button>
                    <button class="btn btn-danger" onclick="deletePreset(${preset.id})" style="font-size: 12px; padding: 5px 10px;">Usu≈Ñ</button>
                </div>
            </div>
        `;
        container.appendChild(div);
    });
}

function loadPreset(presetId) {
    const preset = pricingPresets.find(p => p.id === presetId);
    if (!preset) return;

    document.getElementById('groupSize').value = preset.groupSize;
    document.getElementById('basePrice').value = preset.basePrice;
    document.getElementById('discountType').value = preset.discountType;
    document.getElementById('discountValue').value = preset.discountValue;

    // Ustaw radio button
    if (preset.discountUnit === 'amount') {
        document.getElementById('discountUnitZl').checked = true;
    } else {
        document.getElementById('discountUnitPercent').checked = true;
    }

    calculatePrice();
    showNotification(`Wczytano preset: ${preset.name}`, 'success');
}

function deletePreset(presetId) {
    if (confirm('Czy na pewno chcesz usunƒÖƒá ten preset?')) {
        pricingPresets = pricingPresets.filter(p => p.id !== presetId);
        if (window.localStorage) {
            window.localStorage.setItem('pricingPresets', JSON.stringify(pricingPresets));
        }
        updatePresetsDisplay();
        showNotification('Preset usuniƒôty', 'success');
    }
}

// Inicjalizacja
document.addEventListener('DOMContentLoaded', function() {
loadConfig();
loadGameHistory();
updateStats();
checkESPConnection();

// Event listenery
document.getElementById('searchFilter').addEventListener('input', applyFilters);
document.getElementById('statusFilter').addEventListener('change', applyFilters);

// Wczytaj presety cenowe
if (window.localStorage) {
    const savedPresets = window.localStorage.getItem('pricingPresets');
    if (savedPresets) {
        pricingPresets = JSON.parse(savedPresets);
    }
}

// Sprawdzaj po≈ÇƒÖczenie co 5 sekund
setInterval(checkESPConnection, 5000);
// Sprawdzaj ≈ºƒÖdania podpowiedzi co 1 sekundƒô
setInterval(checkHintRequests, 1000);
// Sprawdzaj status zagadek co 3 sekundy
setInterval(checkPuzzleStatus, 3000);

// Pobierz historiƒô z ESP32 po 3 sekundach (≈ºeby nawiƒÖzaƒá po≈ÇƒÖczenie)
setTimeout(() => {
if (document.getElementById('connectionStatus').textContent.includes('Po≈ÇƒÖczono')) {
loadHistoryFromESP();
}
}, 3000);
});

// Sprawdzenie po≈ÇƒÖczenia z ESP32
function checkESPConnection() {
fetch('/status')
.then(response => response.json())
.then(data => {
updateConnectionStatus('connected');
updateDeviceStatus(true, data.golab_connected || false, data.walizka_connected || false);
updateWiFiInfo(data);
})
.catch(error => {
updateConnectionStatus('disconnected');
updateDeviceStatus(false, false, false);
console.log('Brak po≈ÇƒÖczenia z ESP32');
});
}

// Aktualizacja informacji WiFi
function updateWiFiInfo(data) {
if (data) {
document.getElementById('wifiStatus').textContent = 'Po≈ÇƒÖczony';
document.getElementById('espIP').textContent = data.ip || 'Nieznany';
document.getElementById('wifiSSID').textContent = data.ssid || 'Nieznany';
document.getElementById('wifiRSSI').textContent = (data.rssi || '?') + ' dBm';
}
}

// ≈Åadowanie konfiguracji
function loadConfig() {
const savedConfig = JSON.parse(window.localStorage?.getItem('escapeRoomConfig') || '{}');
config = { ...config, ...savedConfig };
document.getElementById('gameTime').value = config.gameTime;
document.getElementById('autoHintDelay').value = config.autoHintDelay;
document.getElementById('enableTimeNotifications').checked = config.enableTimeNotifications;
document.getElementById('timeInterval').value = config.timeInterval;
document.getElementById('timeAudioFile').value = config.timeAudioFile;

// Wczytaj zapisanƒÖ g≈Ço≈õno≈õƒá
const savedVolume = window.localStorage?.getItem('audioVolume') || '20';
document.getElementById('volumeSlider').value = savedVolume;
document.getElementById('volumeValue').textContent = savedVolume;
}

// Zapisywanie konfiguracji
function saveConfig() {
config.gameTime = parseInt(document.getElementById('gameTime').value);
config.autoHintDelay = parseInt(document.getElementById('autoHintDelay').value);
config.enableTimeNotifications = document.getElementById('enableTimeNotifications').checked;
config.timeInterval = parseInt(document.getElementById('timeInterval').value);
config.timeAudioFile = document.getElementById('timeAudioFile').value;
if (window.localStorage) {
    window.localStorage.setItem('escapeRoomConfig', JSON.stringify(config));
}
showNotification('Konfiguracja zapisana!', 'success');
updateTimeNotificationStatus();
}

// Rozpoczƒôcie gry
function startGame() {
const groupName = document.getElementById('groupName').value.trim();
const playerCount = document.getElementById('playerCount').value;
const isTestGame = document.getElementById('testGame').checked;

if (!groupName) {
showNotification('Proszƒô podaƒá nazwƒô grupy!', 'error');
return;
}

currentSession = {
groupName: groupName,
playerCount: parseInt(playerCount),
difficulty: 'standard', // Tylko jeden poziom
isTestGame: isTestGame,
sessionId: 'SESSION_' + Date.now(),
startTime: new Date(),
hintsUsed: 0,
status: 'active'
};

gameActive = true;
gamePaused = false;
startTime = new Date();

// Aktualizacja UI
document.getElementById('gameStatus').textContent = 'Gra w toku';
document.getElementById('gameStatus').className = 'game-status status-active';
document.getElementById('gameInfo').innerHTML =
`<strong>${groupName}</strong><br>
Graczy: ${playerCount}<br>
${isTestGame ? 'Tryb testowy' : 'Gra w≈Ça≈õciwa'}`;

// Aktywacja przycisk√≥w
document.getElementById('pauseBtn').disabled = false;
document.getElementById('stopBtn').disabled = false;
document.getElementById('completeBtn').disabled = false;

// Start timera
startTimer();

// Start automatycznych powiadomie≈Ñ czasowych
startTimeNotifications();

// Wys≈Çanie do ESP32
sendCommandToESP('start_game', currentSession);
addLog('game', `Rozpoczƒôto grƒô: ${groupName} (${playerCount} graczy)`);
showNotification('Gra rozpoczƒôta!', 'success');
}

// Timer
function startTimer() {
timerInterval = setInterval(updateTimer, 1000);
}

function updateTimer() {
if (!gameActive || gamePaused) return;
const now = new Date();
const elapsed = Math.floor((now - startTime) / 1000);
const minutes = Math.floor(elapsed / 60);
const seconds = elapsed % 60;
document.getElementById('timer').textContent =
`${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Automatyczne podpowiedzi
function startAutoHintTimer() {
if (autoHintTimer) clearInterval(autoHintTimer);
autoHintTimer = setInterval(() => {
if (gameActive && !gamePaused) {
const elapsed = Math.floor((new Date() - startTime) / 1000);
const minutes = Math.floor(elapsed / 60);
// Automatyczne podpowiedzi co X minut
if (minutes > 0 && minutes % config.autoHintDelay === 0) {
showNotification(`Automatyczna podpowied≈∫ po ${minutes} minutach`, 'warning');
playAudio('hint1');
}
}
}, 60000); // Sprawdzaj co minutƒô
}

// Kontrola gry
function pauseGame() {
if (!gameActive) return;
gamePaused = !gamePaused;
const pauseBtn = document.getElementById('pauseBtn');
const status = document.getElementById('gameStatus');
if (gamePaused) {
pauseBtn.textContent = 'Wzn√≥w';
status.textContent = 'Gra wstrzymana';
status.className = 'game-status status-paused';
addLog('game', 'Gra wstrzymana');
} else {
pauseBtn.textContent = 'Pauza';
status.textContent = 'Gra w toku';
status.className = 'game-status status-active';
addLog('game', 'Gra wznowiona');
}
updateTimeNotificationStatus();
sendCommandToESP('pause_game', { paused: gamePaused });
}

function stopGame() {
if (!gameActive) return;
if (confirm('Czy na pewno chcesz zako≈Ñczyƒá grƒô?')) {
endGame('failed');
}
}

function completeGame() {
if (!gameActive) return;
if (confirm('Czy gracze uko≈Ñczyli grƒô?')) {
endGame('completed');
}
}

// Zako≈Ñczenie gry
function endGame(status) {
const endTime = new Date();
const duration = Math.floor((endTime - startTime) / 1000);

// Zatrzymaj timery
clearInterval(timerInterval);
stopTimeNotifications();

// Zapisz grƒô do historii
const gameRecord = {
...currentSession,
endTime: endTime,
duration: duration,
status: currentSession.isTestGame ? 'test' : status,
hintsUsed: currentSession.hintsUsed || 0
};

// Zapisz lokalnie
gameHistory.unshift(gameRecord);
saveGameHistory();

// Zapisz na ESP32
saveGameToESP(gameRecord);

// Reset stanu gry
gameActive = false;
gamePaused = false;
const statusText = status === 'completed' ? 'Gra uko≈Ñczona!' : 'Gra zako≈Ñczona';
document.getElementById('gameStatus').textContent = statusText;
document.getElementById('gameStatus').className = 'game-status status-waiting';

// Dezaktywacja przycisk√≥w
document.getElementById('pauseBtn').disabled = true;
document.getElementById('stopBtn').disabled = true;
document.getElementById('completeBtn').disabled = true;
document.getElementById('pauseBtn').textContent = 'Pauza';

// Wys≈Çanie do ESP32
sendCommandToESP('end_game', { status: status });
const logText = status === 'completed' ? 'uko≈Ñczono' : 'przerwano';
addLog('game', `${logText.charAt(0).toUpperCase() + logText.slice(1)} grƒô: ${currentSession?.groupName} (czas: ${formatDuration(duration)})`);
const notificationText = status === 'completed' ? 'Gra uko≈Ñczona!' : 'Gra zako≈Ñczona';
showNotification(notificationText, status === 'completed' ? 'success' : 'warning');
currentSession = null;
updateStats();
updateTimeNotificationStatus();

// Reset formularza
document.getElementById('groupName').value = '';
document.getElementById('timer').textContent = '00:00';
document.getElementById('gameInfo').innerHTML = 'Brak aktywnej sesji';
}

// Odtwarzanie audio
function playAudio(fileName) {
if (!slaveConnected) {
showNotification('Go≈ÇƒÖb nie jest po≈ÇƒÖczony!', 'error');
return;
}
const command = {
action: 'play_audio',
fileName: fileName,
sessionId: currentSession?.sessionId || null,
timestamp: new Date().toISOString()
};
fetch('/play_audio', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
},
body: JSON.stringify(command)
})
.then(response => response.json())
.then(data => {
if (data.success) {
addLog('hint', `Odtwarzanie: ${fileName}.mp3`);
showNotification(`Odtwarzanie: ${fileName}.mp3`, 'success');
if (currentSession && fileName.includes('hint')) {
currentSession.hintsUsed = (currentSession.hintsUsed || 0) + 1;
}
} else {
addLog('error', `B≈ÇƒÖd odtwarzania: ${data.error}`);
showNotification('B≈ÇƒÖd odtwarzania audio!', 'error');
}
})
.catch(error => {
addLog('error', 'B≈ÇƒÖd komunikacji z ESP32');
showNotification('B≈ÇƒÖd komunikacji z ESP32!', 'error');
});
}

function stopAudio() {
fetch('/stop_audio', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
}
})
.then(response => response.json())
.then(data => {
if (data.success) {
addLog('hint', 'Zatrzymano audio');
showNotification('Audio zatrzymane', 'success');
} else {
showNotification('B≈ÇƒÖd zatrzymywania audio!', 'error');
}
})
.catch(error => {
showNotification('B≈ÇƒÖd komunikacji z ESP32!', 'error');
});
}

// Komunikacja z ESP32
function sendCommandToESP(command, data = {}) {
const payload = {
command: command,
data: data,
timestamp: new Date().toISOString()
};
fetch('/command', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
},
body: JSON.stringify(payload)
})
.then(response => response.json())
.then(result => {
if (result.success) {
addLog('esp32', `Komenda wys≈Çana: ${command}`);
} else {
addLog('error', `B≈ÇƒÖd komendy: ${result.error}`);
}
})
.catch(error => {
addLog('error', `B≈ÇƒÖd komunikacji: ${error}`);
});
}

// Aktualizacja statusu po≈ÇƒÖczenia
function updateConnectionStatus(status) {
const statusElement = document.getElementById('connectionStatus');
switch(status) {
case 'connected':
statusElement.textContent = 'üü¢ Po≈ÇƒÖczono';
statusElement.className = 'connection-status connected';
break;
case 'connecting':
statusElement.textContent = 'üü° ≈ÅƒÖczenie...';
statusElement.className = 'connection-status connecting';
break;
case 'disconnected':
statusElement.textContent = 'üî¥ Roz≈ÇƒÖczono';
statusElement.className = 'connection-status disconnected';
break;
}
}

// Aktualizacja statusu urzƒÖdze≈Ñ
function updateDeviceStatus(masterConnected, golabConnected = false, walizkaConnected = false) {
const masterElement = document.getElementById('masterStatus');
const slaveElement = document.getElementById('slaveStatus');
const slave3Element = document.getElementById('slave3Status');
// Status Master
if (masterConnected) {
masterElement.textContent = 'üü¢ Master: ONLINE';
masterElement.className = 'device-status device-online';
} else {
masterElement.textContent = 'üî¥ Master: OFFLINE';
masterElement.className = 'device-status device-offline';
}
// Status Go≈ÇƒÖb
slaveConnected = golabConnected;
if (golabConnected) {
slaveElement.textContent = 'üü¢ Go≈ÇƒÖb: ONLINE';
slaveElement.className = 'device-status device-online';
} else {
slaveElement.textContent = 'üî¥ Go≈ÇƒÖb: OFFLINE';
slaveElement.className = 'device-status device-offline';
}
// Status Walizka
slave3Connected = walizkaConnected;
if (walizkaConnected) {
slave3Element.textContent = 'üü¢ Walizka: ONLINE';
slave3Element.className = 'device-status device-online';
} else {
slave3Element.textContent = 'üî¥ Walizka: OFFLINE';
slave3Element.className = 'device-status device-offline';
}
}

// Sprawdzanie ≈ºƒÖda≈Ñ podpowiedzi
function checkHintRequests() {
fetch('/hint_status')
.then(response => response.json())
.then(data => {
if (data.hint_requested) {
showHintRequest();
playBeepInBrowser();
}
})
.catch(error => {
// Brak po≈ÇƒÖczenia - ignoruj b≈ÇƒÖd
});
}

function playBeepInBrowser() {
// Pr√≥ba odtworzenia beep.mp3 z serwera ESP32
fetch('/beep.mp3')
.then(response => {
if (response.ok) {
return response.blob();
}
throw new Error('Brak pliku beep.mp3');
})
.then(blob => {
const audio = new Audio();
audio.src = URL.createObjectURL(blob);
audio.play().catch(e => {
console.log('Nie mo≈ºna odtworzyƒá beep - wymagana interakcja u≈ºytkownika');
// Fallback - prosty beep systemowy
playSystemBeep();
});
})
.catch(error => {
console.log('B≈ÇƒÖd ≈Çadowania beep.mp3:', error);
// Fallback - prosty beep systemowy
playSystemBeep();
});
}

function playSystemBeep() {
// Backup - systemowy beep przez AudioContext
try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    oscillator.frequency.value = 800; // 800Hz
    oscillator.type = 'sine';
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.5);
} catch (e) {
    console.log('Beep systemowy niedostƒôpny');
}
}

// Automatyczne powiadomienia czasowe
function startTimeNotifications() {
if (!config.enableTimeNotifications || !gameActive) {
updateTimeNotificationStatus();
return;
}
lastTimeNotification = 0;
timeNotificationTimer = setInterval(() => {
if (!gameActive || gamePaused || !config.enableTimeNotifications) {
return;
}
const elapsed = Math.floor((new Date() - startTime) / 1000);
const elapsedMinutes = Math.floor(elapsed / 60);
// Sprawd≈∫ czy minƒÖ≈Ç kolejny interwa≈Ç
const nextNotification = lastTimeNotification + config.timeInterval;
if (elapsedMinutes >= nextNotification && elapsedMinutes > 0) {
sendTimeNotification(elapsedMinutes);
lastTimeNotification = elapsedMinutes;
}
}, 60000); // Sprawdzaj co minutƒô
updateTimeNotificationStatus();
}

function stopTimeNotifications() {
if (timeNotificationTimer) {
clearInterval(timeNotificationTimer);
timeNotificationTimer = null;
}
lastTimeNotification = 0;
updateTimeNotificationStatus();
}

function sendTimeNotification(minutes) {
if (!slaveConnected) {
addLog('hint', `Powiadomienie czasowe (${minutes} min) - Go≈ÇƒÖb offline`);
return;
}
playAudio(config.timeAudioFile);
addLog('hint', `‚è∞ Automatyczne powiadomienie: ${minutes} minut`);
showNotification(`Powiadomienie: ${minutes} minut`, 'warning');
}

function updateTimeNotificationStatus() {
const statusElement = document.getElementById('timeNotificationStatus');
if (!gameActive) {
statusElement.textContent = 'Status: Wy≈ÇƒÖczone (brak aktywnej gry)';
statusElement.style.color = '#666';
} else if (!config.enableTimeNotifications) {
statusElement.textContent = 'Status: Wy≈ÇƒÖczone w konfiguracji';
statusElement.style.color = '#ab0911';
} else if (gamePaused) {
statusElement.textContent = 'Status: Wstrzymane (gra w pauzie)';
statusElement.style.color = '#6b5a2d';
} else {
const nextTime = lastTimeNotification + config.timeInterval;
statusElement.textContent = `Status: Aktywne (nastƒôpne: ${nextTime} min)`;
statusElement.style.color = '#4a5a4a';
}
}

function showPanel(panelName) {
document.getElementById('gamePanel').style.display = 'none';
document.getElementById('puzzlesPanel').style.display = 'none';
document.getElementById('historyPanel').style.display = 'none';
document.getElementById('pricingPanel').style.display = 'none';
document.getElementById('configPanel').style.display = 'none';
document.getElementById(panelName + 'Panel').style.display = 'block';
document.getElementById('gameTab').className = 'btn ' + (panelName === 'game' ? 'btn-primary' : 'btn-success');
document.getElementById('puzzlesTab').className = 'btn ' + (panelName === 'puzzles' ? 'btn-primary' : 'btn-success');
document.getElementById('historyTab').className = 'btn ' + (panelName === 'history' ? 'btn-primary' : 'btn-success');
document.getElementById('pricingTab').className = 'btn ' + (panelName === 'pricing' ? 'btn-primary' : 'btn-warning');
document.getElementById('configTab').className = 'btn ' + (panelName === 'config' ? 'btn-primary' : 'btn-warning');
currentPanel = panelName;
if (panelName === 'history') {
loadGameHistory();
} else if (panelName === 'config') {
updateTimeNotificationStatus();
} else if (panelName === 'pricing') {
setTimeout(() => {
resetPricing();
updatePresetsDisplay();
}, 100);
} else if (panelName === 'puzzles') {
setTimeout(() => {
updatePuzzleDisplay();
checkPuzzleStatus();
}, 100);
}
}

// ZarzƒÖdzanie historiƒÖ
function loadGameHistory() {
try {
const saved = window.localStorage?.getItem('escapeRoomHistory');
if (saved) {
gameHistory = JSON.parse(saved);
}
} catch (e) {
console.error('B≈ÇƒÖd ≈Çadowania historii:', e);
gameHistory = [];
}
const historyContainer = document.getElementById('gameHistory');
historyContainer.innerHTML = '';
if (gameHistory.length === 0) {
historyContainer.innerHTML = '<p style="text-align: center; color: #666;">Brak zapisanych gier</p>';
return;
}
const filteredHistory = applyFiltersToHistory();
filteredHistory.forEach(game => {
const gameElement = createGameHistoryElement(game);
historyContainer.appendChild(gameElement);
});
}

// Zapisz grƒô na ESP32
function saveGameToESP(gameData) {
fetch('/save_game', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
},
body: JSON.stringify(gameData)
})
.then(response => response.json())
.then(data => {
if (data.success) {
addLog('esp32', 'Gra zapisana na ESP32');
} else {
addLog('error', 'B≈ÇƒÖd zapisu gry na ESP32: ' + data.error);
}
})
.catch(error => {
addLog('error', 'B≈ÇƒÖd komunikacji z ESP32 podczas zapisu gry');
});
}

// Pobierz historiƒô z ESP32
function loadHistoryFromESP() {
fetch('/get_history')
.then(response => response.json())
.then(data => {
if (data.games && Array.isArray(data.games)) {
gameHistory = data.games;
if (window.localStorage) {
    window.localStorage.setItem('escapeRoomHistory', JSON.stringify(gameHistory));
}
loadGameHistory();
updateStats();
showNotification(`Pobrano ${data.games.length} gier z ESP32`, 'success');
addLog('esp32', `Historia pobrana z ESP32: ${data.games.length} gier`);
} else {
showNotification('Brak historii na ESP32', 'warning');
}
})
.catch(error => {
showNotification('B≈ÇƒÖd pobierania historii z ESP32!', 'error');
addLog('error', 'B≈ÇƒÖd pobierania historii z ESP32');
});
}

// Eksport do CSV
function exportToCSV() {
fetch('/export_history')
.then(response => {
if (response.ok) {
return response.blob();
} else {
throw new Error('B≈ÇƒÖd generowania pliku CSV');
}
})
.then(blob => {
const url = window.URL.createObjectURL(blob);
const a = document.createElement('a');
a.style.display = 'none';
a.href = url;
const now = new Date();
const dateStr = now.getFullYear() + '-' + 
String(now.getMonth() + 1).padStart(2, '0') + '-' + 
String(now.getDate()).padStart(2, '0');
a.download = `historia_gier_${dateStr}.csv`;
document.body.appendChild(a);
a.click();
window.URL.revokeObjectURL(url);
document.body.removeChild(a);
showNotification('Plik CSV zosta≈Ç pobrany!', 'success');
addLog('esp32', 'Historia wyeksportowana do CSV');
})
.catch(error => {
showNotification('B≈ÇƒÖd eksportu do CSV!', 'error');
addLog('error', 'B≈ÇƒÖd eksportu historii do CSV');
});
}

function saveGameHistory() {
try {
if (window.localStorage) {
    window.localStorage.setItem('escapeRoomHistory', JSON.stringify(gameHistory));
}
} catch (e) {
console.error('B≈ÇƒÖd zapisywania historii:', e);
showNotification('B≈ÇƒÖd zapisywania historii!', 'error');
}
}

function createGameHistoryElement(game) {
const div = document.createElement('div');
div.className = 'game-history-item';
const statusClass = game.status === 'completed' ? 'status-completed' :
game.status === 'test' ? 'status-test' : 'status-failed';
const statusText = game.status === 'completed' ? 'Uko≈Ñczono' :
game.status === 'test' ? 'Test' : 'Nieuko≈Ñczono';
div.innerHTML = `
<div class="game-header">
<div class="game-title">${escapeHtml(game.groupName)}</div>
<div class="game-date">${formatDate(game.startTime)}</div>
</div>
<div class="game-details">
<div class="game-detail">üë• Graczy: ${game.playerCount}</div>
<div class="game-detail">‚è±Ô∏è Czas: ${formatDuration(game.duration)}</div>
<div class="game-detail">üéµ Audio: ${game.hintsUsed || 0}</div>
<div class="game-detail">
<span class="game-status-badge ${statusClass}">${statusText}</span>
</div>
</div>
<div style="text-align: right; margin-top: 10px;">
<button class="btn btn-danger" onclick="deleteGame('${game.sessionId}')" style="font-size: 12px; padding: 5px 10px;">üóëÔ∏è Usu≈Ñ</button>
</div>
`;
return div;
}

function applyFiltersToHistory() {
const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
const statusFilter = document.getElementById('statusFilter').value;
return gameHistory.filter(game => {
const matchesSearch = game.groupName.toLowerCase().includes(searchTerm);
const matchesStatus = !statusFilter || game.status === statusFilter;
return matchesSearch && matchesStatus;
});
}

function applyFilters() {
loadGameHistory();
}

function deleteGame(sessionId) {
if (confirm('Czy na pewno chcesz usunƒÖƒá tƒô grƒô z historii?')) {
gameHistory = gameHistory.filter(game => game.sessionId !== sessionId);
saveGameHistory();
loadGameHistory();
updateStats();
showNotification('Gra usuniƒôta z historii', 'success');
}
}

function clearHistory() {
if (confirm('Czy na pewno chcesz wyczy≈õciƒá ca≈ÇƒÖ historiƒô gier?')) {
gameHistory = [];
saveGameHistory();
loadGameHistory();
updateStats();
showNotification('Historia wyczyszczona', 'success');
}
}

// Statystyki
function updateStats() {
const statsContainer = document.getElementById('statsContent');
if (gameHistory.length === 0) {
statsContainer.innerHTML = '<p>Brak danych</p>';
return;
}
const totalGames = gameHistory.length;
const completedGames = gameHistory.filter(g => g.status === 'completed').length;
const testGames = gameHistory.filter(g => g.status === 'test').length;
const realGames = totalGames - testGames;
const averageTime = gameHistory.reduce((sum, g) => sum + (g.duration || 0), 0) / totalGames;
const totalHints = gameHistory.reduce((sum, g) => sum + (g.hintsUsed || 0), 0);
const successRate = realGames > 0 ? Math.round((completedGames / realGames) * 100) : 0;
statsContainer.innerHTML = `
<div class="stats-grid">
<div class="stat-item">
<div class="stat-value">${totalGames}</div>
<div class="stat-label">üìä Wszystkich gier</div>
</div>
<div class="stat-item">
<div class="stat-value">${completedGames}</div>
<div class="stat-label">‚úÖ Uko≈Ñczonych</div>
</div>
<div class="stat-item">
<div class="stat-value">${successRate}%</div>
<div class="stat-label">üéØ % Sukcesu</div>
</div>
<div class="stat-item">
<div class="stat-value">${formatDuration(Math.round(averageTime))}</div>
<div class="stat-label">‚è±Ô∏è ≈öredni czas</div>
</div>
<div class="stat-item">
<div class="stat-value">${totalHints}</div>
<div class="stat-label">üéµ Audio u≈ºyte</div>
</div>
<div class="stat-item">
<div class="stat-value">${testGames}</div>
<div class="stat-label">üß™ Gier testowych</div>
</div>
</div>
`;
}

// Sterowanie g≈Ço≈õno≈õciƒÖ
function setVolume(volume) {
document.getElementById('volumeValue').textContent = volume;
if (window.localStorage) {
window.localStorage.setItem('audioVolume', volume);
}

fetch('/set_volume', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
},
body: JSON.stringify({ volume: parseInt(volume) })
})
.then(response => response.json())
.then(data => {
if (data.success) {
addLog('esp32', `G≈Ço≈õno≈õƒá ustawiona na: ${volume}`);
} else {
addLog('error', `B≈ÇƒÖd ustawiania g≈Ço≈õno≈õci: ${data.error}`);
showNotification('B≈ÇƒÖd ustawiania g≈Ço≈õno≈õci!', 'error');
}
})
.catch(error => {
addLog('error', 'B≈ÇƒÖd komunikacji z ESP32');
showNotification('B≈ÇƒÖd komunikacji z ESP32!', 'error');
});
}

// Funkcje restart z countdown
function startCountdown(type, seconds = 5) {
const countdownElement = document.getElementById('restartCountdown');
countdownElement.style.display = 'block';
let timeLeft = seconds;

const countdownInterval = setInterval(() => {
countdownElement.textContent = `${type} za ${timeLeft} sekund...`;
timeLeft--;

if (timeLeft < 0) {
clearInterval(countdownInterval);
countdownElement.style.display = 'none';
// Auto-reconnect po restarcie
setTimeout(() => {
updateConnectionStatus('connecting');
checkESPConnection();
}, type.includes('Master') || type.includes('All') ? 10000 : 3000);
}
}, 1000);
}

function restartMaster() {
if (confirm('Czy na pewno chcesz zrestartowaƒá ESP32 Master?')) {
fetch('/restart', {
method: 'POST'
})
.then(response => response.json())
.then(data => {
showNotification('ESP32 Master zostanie zrestartowany...', 'warning');
addLog('esp32', 'Restart Master');
startCountdown('Restart Master', 5);
})
.catch(error => {
showNotification('B≈ÇƒÖd restartu Master!', 'error');
});
}
}

function restartSlave() {
if (confirm('Czy na pewno chcesz zrestartowaƒá Go≈ÇƒÖb?')) {
fetch('/restart_slave', {
method: 'POST'
})
.then(response => response.json())
.then(data => {
if (data.success) {
showNotification('Go≈ÇƒÖb zostanie zrestartowany...', 'warning');
addLog('esp32', 'Restart Go≈ÇƒÖb');
startCountdown('Restart Go≈ÇƒÖb', 3);
} else {
showNotification('B≈ÇƒÖd restartu Go≈ÇƒÖb!', 'error');
}
})
.catch(error => {
showNotification('B≈ÇƒÖd komunikacji z ESP32!', 'error');
});
}
}

function restartAll() {
if (confirm('Czy na pewno chcesz zrestartowaƒá ca≈Çy system (Master + Go≈ÇƒÖb)?')) {
fetch('/restart_all', {
method: 'POST'
})
.then(response => response.json())
.then(data => {
showNotification('Ca≈Çy system zostanie zrestartowany...', 'warning');
addLog('esp32', 'Restart ca≈Çego systemu');
startCountdown('Restart systemu', 8);
})
.catch(error => {
showNotification('B≈ÇƒÖd restartu systemu!', 'error');
});
}
}

// Funkcje konfiguracyjne
function testConnection() {
showNotification('Testowanie po≈ÇƒÖczenia...', 'warning');
checkESPConnection();
}

function resetConfig() {
if (confirm('Czy na pewno chcesz przywr√≥ciƒá domy≈õlne ustawienia?')) {
config = {
gameTime: 60,
autoHintDelay: 15,
enableTimeNotifications: true,
timeInterval: 15,
timeAudioFile: 'time_warning'
};
document.getElementById('gameTime').value = config.gameTime;
document.getElementById('autoHintDelay').value = config.autoHintDelay;
document.getElementById('enableTimeNotifications').checked = config.enableTimeNotifications;
document.getElementById('timeInterval').value = config.timeInterval;
document.getElementById('timeAudioFile').value = config.timeAudioFile;
if (window.localStorage) {
    window.localStorage.removeItem('escapeRoomConfig');
}
showNotification('Przywr√≥cono domy≈õlne ustawienia', 'success');
}
}

function diagnostics() {
fetch('/diagnostics', {
method: 'POST'
})
.then(response => response.json())
.then(data => {
showNotification('Diagnostyka uruchomiona', 'success');
addLog('esp32', 'Wyniki diagnostyki: ' + JSON.stringify(data));
})
.catch(error => {
showNotification('B≈ÇƒÖd diagnostyki!', 'error');
});
}

function checkAudioFiles() {
fetch('/audio_files')
.then(response => response.json())
.then(data => {
if (data.files && data.files.length > 0) {
showNotification(`Znaleziono ${data.files.length} plik√≥w audio`, 'success');
addLog('esp32', 'Pliki audio: ' + data.files.join(', '));
} else {
showNotification('Nie znaleziono plik√≥w audio!', 'warning');
}
})
.catch(error => {
showNotification('B≈ÇƒÖd sprawdzania plik√≥w audio!', 'error');
});
}

// Obs≈Çuga ≈ºƒÖda≈Ñ podpowiedzi
function showHintRequest() {
document.getElementById('hintRequest').style.display = 'block';
addLog('hint', 'Gracze proszƒÖ o podpowied≈∫! (Go≈ÇƒÖb)');
showNotification('Gracze proszƒÖ o podpowied≈∫!', 'warning');
setTimeout(hideHintRequest, 30000);
}

function hideHintRequest() {
document.getElementById('hintRequest').style.display = 'none';
}

// System log√≥w
function addLog(type, message) {
const logs = document.getElementById('logs');
const timestamp = new Date().toLocaleTimeString();
const logEntry = document.createElement('div');
logEntry.className = `log-entry log-${type}`;
const typeEmojis = {
'game': 'üéÆ',
'hint': 'üéµ',
'error': '‚ùå',
'esp32': 'üì°'
};
logEntry.innerHTML = `<strong>[${timestamp}] ${typeEmojis[type] || 'üìù'}</strong> ${escapeHtml(message)}`;
logs.insertBefore(logEntry, logs.firstChild);
while (logs.children.length > 100) {
logs.removeChild(logs.lastChild);
}
}

function clearLogs() {
if (confirm('Czy na pewno chcesz wyczy≈õciƒá logi?')) {
document.getElementById('logs').innerHTML = '';
addLog('esp32', 'Logi wyczyszczone');
}
}

// System powiadomie≈Ñ
function showNotification(message, type = 'success') {
const existing = document.querySelector('.notification');
if (existing) {
existing.remove();
}
const notification = document.createElement('div');
notification.className = `notification notification-${type}`;
notification.textContent = message;
document.body.appendChild(notification);
setTimeout(() => {
notification.classList.add('show');
}, 100);
setTimeout(() => {
notification.classList.remove('show');
setTimeout(() => {
if (notification.parentNode) {
notification.remove();
}
}, 300);
}, 4000);
}

// Funkcje pomocnicze
function formatDate(dateString) {
const date = new Date(dateString);
return date.toLocaleDateString('pl-PL') + ' ' + date.toLocaleTimeString('pl-PL', {hour: '2-digit', minute: '2-digit'});
}

function formatDuration(seconds) {
const minutes = Math.floor(seconds / 60);
const secs = seconds % 60;
return `${minutes}:${secs.toString().padStart(2, '0')}`;
}

function escapeHtml(text) {
const div = document.createElement('div');
div.textContent = text;
return div.innerHTML;
}

// Funkcja testowa - dodana na ko≈Ñcu
function simulateHintRequest() {
showHintRequest();
playBeepInBrowser();
}

// Obs≈Çuga skr√≥t√≥w klawiszowych
document.addEventListener('keydown', function(e) {
if ((e.ctrlKey || e.metaKey) && !e.shiftKey && !e.altKey) {
switch(e.key) {
case '1':
e.preventDefault();
showPanel('game');
break;
case '2':
e.preventDefault();
showPanel('puzzles');
break;
case '3':
e.preventDefault();
showPanel('history');
break;
case '4':
e.preventDefault();
showPanel('pricing');
break;
case '5':
e.preventDefault();
showPanel('config');
break;
case ' ':
e.preventDefault();
if (gameActive) {
pauseGame();
}
break;
}
}
if (e.key === 'Escape') {
hideHintRequest();
}
});

// Symulacja przycisk go≈ÇƒÖb - TYLKO DO TEST√ìW
// Usu≈Ñ tƒô funkcjƒô w produkcji
document.addEventListener('keydown', function(e) {
if (e.key === 'h' && e.ctrlKey) {
e.preventDefault();
simulateHintRequest();
}
});

console.log('üïäÔ∏è Panel Go≈ÇƒÖb - Skr√≥ty klawiszowe:');
console.log('Ctrl+1: Panel Gry');
console.log('Ctrl+2: Zagadki');
console.log('Ctrl+3: Historia');
console.log('Ctrl+4: Cennik');
console.log('Ctrl+5: Konfiguracja');
console.log('Ctrl+Spacja: Pauza/Wzn√≥w grƒô');
console.log('Ctrl+H: Symuluj ≈ºƒÖdanie podpowiedzi (TEST)');
console.log('Escape: Ukryj ≈ºƒÖdanie podpowiedzi');
console.log('üîä NOWE: Suwak g≈Ço≈õno≈õci audio (0-30)');
console.log('üîÑ NOWE: Osobne restarty Master/Slave/All');
console.log('üß© NOWE: Panel Zagadki z Walizka LOTTO');

// ===== FUNKCJE ZAGADEK =====

// Sprawdzanie statusu zagadek
function checkPuzzleStatus() {
fetch('/puzzle_status')
.then(response => response.json())
.then(data => {
if (data.walizka) {
puzzleStates.walizka = {...puzzleStates.walizka, ...data.walizka};
updatePuzzleDisplay();
}
})
.catch(error => {
console.log('Brak po≈ÇƒÖczenia z systemem zagadek');
});
}

// Aktualizacja wy≈õwietlania zagadki
function updatePuzzleDisplay() {
const walizka = puzzleStates.walizka;
// Aktualizuj wska≈∫niki etap√≥w
updateStageIndicator('stage1Status', walizka.stage === 'WAITING_TAG1' ? 'active' : 
    (walizka.stage === 'KEYPAD_ACTIVE' || walizka.stage === 'WAITING_TAG2' || walizka.stage === 'COMPLETED') ? 'completed' : 'waiting');
updateStageIndicator('stage2Status', walizka.stage === 'KEYPAD_ACTIVE' ? 'active' : 
    (walizka.stage === 'WAITING_TAG2' || walizka.stage === 'COMPLETED') ? 'completed' : 'waiting');
updateStageIndicator('stage3Status', walizka.stage === 'WAITING_TAG2' ? 'active' : 
    walizka.stage === 'COMPLETED' ? 'completed' : 'waiting');

// Aktualizuj historiƒô kod√≥w
updateCodesHistory();
// Aktualizuj statystyki cyfr
updateDigitStats();
}

// Aktualizacja wska≈∫nika etapu
function updateStageIndicator(elementId, status) {
const element = document.getElementById(elementId);
if (element) {
element.className = `stage-indicator stage-${status}`;
}
}

// Aktualizacja historii kod√≥w
function updateCodesHistory() {
const container = document.getElementById('codesHistory');
if (!container) return;

const codes = puzzleStates.walizka.codesHistory;
if (codes.length === 0) {
container.innerHTML = '<div style="color: #666; text-align: center; padding: 10px;">Brak pr√≥b</div>';
return;
}

container.innerHTML = '';
codes.slice(-10).reverse().forEach(entry => {
const div = document.createElement('div');
div.className = `code-entry ${entry.correct ? 'code-entry-correct' : ''}`;
div.innerHTML = `
<div class="code-entry-code">${entry.code}</div>
<div class="code-entry-time">${entry.timestamp}</div>
`;
container.appendChild(div);
});
}

// Aktualizacja statystyk cyfr
function updateDigitStats() {
const container = document.getElementById('digitStats');
if (!container) return;

const stats = puzzleStates.walizka.digitStats;
const maxCount = Math.max(...Object.values(stats)) || 1;

container.innerHTML = '';
for (let digit = 0; digit <= 9; digit++) {
const count = stats[digit] || 0;
const percentage = (count / maxCount) * 100;
    
const div = document.createElement('div');
div.className = 'digit-stat';
div.innerHTML = `
<div class="digit-stat-number">${digit}</div>
<div class="digit-stat-bar">
<div class="digit-stat-fill" style="width: ${percentage}%"></div>
</div>
<div class="digit-stat-count">${count}</div>
`;
container.appendChild(div);
}
}

// Otw√≥rz zamek
function openLock() {
if (!slave3Connected) {
showNotification('Walizka nie jest po≈ÇƒÖczona!', 'error');
return;
}

fetch('/puzzle_command', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
},
body: JSON.stringify({
puzzle: 'walizka',
command: 'open_lock',
timestamp: new Date().toISOString()
})
})
.then(response => response.json())
.then(data => {
if (data.success) {
showNotification('Zamek otwarto!', 'success');
addLog('esp32', 'Walizka: Zamek otwarty przez panel');
} else {
showNotification('B≈ÇƒÖd otwierania zamka!', 'error');
}
})
.catch(error => {
showNotification('B≈ÇƒÖd komunikacji z ESP32!', 'error');
});
}

// Reset zagadki
function resetPuzzle(puzzleName) {
if (!slave3Connected) {
showNotification('Walizka nie jest po≈ÇƒÖczona!', 'error');
return;
}

if (confirm('Czy na pewno chcesz zresetowaƒá zagadkƒô?')) {
fetch('/puzzle_command', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
},
body: JSON.stringify({
puzzle: puzzleName,
command: 'reset',
timestamp: new Date().toISOString()
})
})
.then(response => response.json())
.then(data => {
if (data.success) {
// Reset lokalnego stanu
puzzleStates.walizka = {
stage: 'WAITING_TAG1',
codesHistory: [],
digitStats: {0:0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0},
relayState: false,
lastUpdate: Date.now()
};
updatePuzzleDisplay();
showNotification('Zagadka zresetowana!', 'success');
addLog('esp32', 'Walizka: Reset przez panel');
} else {
showNotification('B≈ÇƒÖd resetowania zagadki!', 'error');
}
})
.catch(error => {
showNotification('B≈ÇƒÖd komunikacji z ESP32!', 'error');
});
}
}

// Restart Slave3 (Walizka)
function restartSlave3() {
if (confirm('Czy na pewno chcesz zrestartowaƒá Walizka?')) {
fetch('/restart_slave3', {
method: 'POST'
})
.then(response => response.json())
.then(data => {
if (data.success) {
showNotification('Walizka zostanie zrestartowana...', 'warning');
addLog('esp32', 'Restart Walizka');
startCountdown('Restart Walizka', 3);
} else {
showNotification('B≈ÇƒÖd restartu Walizka!', 'error');
}
})
.catch(error => {
showNotification('B≈ÇƒÖd komunikacji z ESP32!', 'error');
});
}
}
</script>
</body>
</html>